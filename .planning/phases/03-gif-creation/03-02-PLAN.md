---
phase: 03-gif-creation
plan: 02
type: execute
depends_on: ["03-01"]
files_modified: [package.json, src/entrypoints/youtube.content/GifEncoder.ts, src/entrypoints/youtube.content/GifCreator.tsx, src/entrypoints/youtube.content/App.tsx]
---

<objective>
Implement video-to-GIF conversion engine using gifenc.

Purpose: Capture video frames and encode them into a downloadable GIF file.
Output: Working GIF generation from YouTube videos with progress indication and download capability.
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-plan.md
~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-gif-creation/03-01-SUMMARY.md
@src/entrypoints/youtube.content/GifCreator.tsx
@src/entrypoints/youtube.content/App.tsx

**Tech available:** React 19, WXT, TypeScript, Shadow DOM
**Established patterns:** Shadow DOM UI, YouTube video element access via document.querySelector

**Discovery findings:**
- Use gifenc library (fast, ESM support, works in browser)
- Approach: Canvas drawImage() → getImageData() → gifenc quantize/applyPalette → encode
- YouTube videos accessible via content script same-origin context
- GIFit reference implementation confirms this approach works
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install gifenc and create encoder service</name>
  <files>package.json, src/entrypoints/youtube.content/GifEncoder.ts</files>
  <action>
Install gifenc: `npm install gifenc`

Create GifEncoder.ts with encoding logic:

```typescript
import { GIFEncoder, quantize, applyPalette } from 'gifenc';

export interface GifEncoderOptions {
  video: HTMLVideoElement;
  startTime: number;
  endTime: number;
  fps: number;
  width: number;
  onProgress?: (percent: number) => void;
}

export async function createGif(options: GifEncoderOptions): Promise<Blob> {
  // Implementation:
  // 1. Calculate height from video aspect ratio
  // 2. Create offscreen canvas at target dimensions
  // 3. Create GIFEncoder with dimensions
  // 4. For each frame (based on fps and duration):
  //    a. Seek video to frame time
  //    b. Wait for seek complete (video.onseeked)
  //    c. Draw video to canvas (ctx.drawImage)
  //    d. Get imageData (ctx.getImageData)
  //    e. Quantize palette from RGBA data
  //    f. Apply palette to get indexed pixels
  //    g. Write frame to encoder
  //    h. Call onProgress with percentage
  // 5. Finish encoder and return Blob
}
```

Key implementation details:
- Use video.currentTime = time; await seeked event to seek accurately
- Frame delay = 1000/fps (in ms, but gifenc uses centiseconds, so divide by 10)
- Handle aspect ratio: height = width * (video.videoHeight / video.videoWidth)
- Wrap seek in Promise for async/await pattern

Avoid: Don't use requestAnimationFrame for frame timing - we need precise seek-based capture.
  </action>
  <verify>`npm run build` succeeds, GifEncoder.ts compiles without errors</verify>
  <done>gifenc installed, GifEncoder.ts exports createGif function with proper TypeScript types</done>
</task>

<task type="auto">
  <name>Task 2: Integrate encoder with UI and add progress display</name>
  <files>src/entrypoints/youtube.content/GifCreator.tsx, src/entrypoints/youtube.content/App.tsx</files>
  <action>
Update GifCreator.tsx:
1. Add encoding state: 'idle' | 'encoding' | 'complete' | 'error'
2. Add progress state: number (0-100)
3. Add resultBlob state: Blob | null
4. When Create GIF clicked:
   - Set state to 'encoding'
   - Call createGif with onProgress callback to update progress
   - On success: set state to 'complete', store blob
   - On error: set state to 'error', show error message
5. During encoding: show progress bar (percentage) and "Encoding..." text
6. Disable Create button during encoding

Update App.tsx:
- Pass actual createGif handler (import from GifEncoder.ts)
- Handle encoding lifecycle in GifCreator component

UI states:
- idle: show settings form with Create GIF button
- encoding: show progress bar, disable inputs
- complete: show GIF preview and Download button
- error: show error message and Retry button
  </action>
  <verify>Click Create GIF → progress bar animates → GIF generation completes or shows error</verify>
  <done>Progress bar displays during encoding, encoding completes successfully for short clips</done>
</task>

<task type="auto">
  <name>Task 3: Add GIF preview and download functionality</name>
  <files>src/entrypoints/youtube.content/GifCreator.tsx, src/entrypoints/youtube.content/style.css</files>
  <action>
Update GifCreator for 'complete' state:
1. Create object URL from blob: URL.createObjectURL(resultBlob)
2. Display GIF preview as <img> element with object URL src
3. Add "Download GIF" button that triggers download:
   ```typescript
   const a = document.createElement('a');
   a.href = objectUrl;
   a.download = `youtube-gif-${Date.now()}.gif`;
   a.click();
   ```
4. Add "Create Another" button to reset state to 'idle'
5. Clean up object URL on unmount or when creating new GIF (URL.revokeObjectURL)

Add CSS for preview state:
- GIF preview container with max dimensions
- Download button with green/success color (#2e7d32)
- "Create Another" as secondary action

Handle large GIFs: if blob size > 10MB, show warning about file size.
  </action>
  <verify>After encoding completes → GIF preview displays → Download button saves file → Create Another resets UI</verify>
  <done>GIF preview displays, download works, can create multiple GIFs in sequence</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds for both Chrome and Firefox
- [ ] gifenc is listed in package.json dependencies
- [ ] Select 2-3 second range on YouTube video → Create GIF → progress shows → GIF displays
- [ ] Download button saves GIF file to disk
- [ ] GIF file opens correctly in image viewer
- [ ] Create Another allows creating multiple GIFs
- [ ] Error handling: shows error message if encoding fails
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Can create GIF from any YouTube video (non-DRM)
- Progress indication during encoding
- Download functionality works
- Phase 3 complete
</success_criteria>

<output>
After completion, create `.planning/phases/03-gif-creation/03-02-SUMMARY.md`
</output>
